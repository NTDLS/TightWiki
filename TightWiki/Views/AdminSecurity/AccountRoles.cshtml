@using TightWiki.Library
@using TightWiki.Models
@using TightWiki.Models.ViewModels.AdminSecurity
@inject IViewLocalizer Localizer
@model AccountRolesViewModel
@{
    Layout = "_Layout";
    var sessionState = ViewData["SessionState"] as TightWiki.SessionState ?? throw new Exception("Wiki State Context cannot be null.");
}

<h3>
    @Localizer.Format("Account Roles and Permissions for: {0}", Model.AccountName)
</h3>

<p>
    @Localizer["Account roles and permissions for a single account."]
</p>

@using (Html.BeginForm(null, null, FormMethod.Post, new { action = $"{GlobalConfiguration.BasePath}{Context.Request.Path}" }))
{
    @Html.AntiForgeryToken()

    <div class="card shadow-lg">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center" id="toolbar">
                <div>
                    @*Left-aligned "toolbar" controls*@
                    <h4>@Localizer["Account Permissions"]</h4>
                </div>

                <div>
                    @*Right-aligned "toolbar" controls*@
                    <button type="button" id="addPermissionToAccountButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPermissionToAccountModal">
                        @Localizer["Add Permission to Account"]
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            @TightWiki.Library.PageSelectorGenerator.Generate(Context.Request.QueryString, Model.PaginationPageCount_Permissions, "Page_Permissions")

            <table id="permissionsTable" class="table fixedTable100 table-striped mb-3" border="0" cellspacing="0" cellpadding="0">
                <thead>
                    <tr>
                        <td><strong><a href="?@QueryStringConverter.OrderHelper(sessionState, "Disposition", "Permissions")">@Localizer["Disposition"]</a></strong></td>
                        <td><strong><a href="?@QueryStringConverter.OrderHelper(sessionState, "Permission", "Permissions")">@Localizer["Permission"]</a></strong></td>
                        <td><strong><a href="?@QueryStringConverter.OrderHelper(sessionState, "Resource", "Permissions")">@Localizer["Resource"]</a></strong></td>
                        <td><strong>@Localizer["Action"]</strong></td>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var permission in Model.AssignedPermissions)
                    {
                        <tr>
                            <td>
                                @(Html.Raw(string.Equals(permission.PermissionDisposition, "Allow", StringComparison.OrdinalIgnoreCase) ? "<i class=\"bi bi-check2 text-success\"></i>" : "<i class=\"bi bi-ban text-danger\"></i>"))
                                @permission.PermissionDisposition
                            </td>
                            <td>@permission.Permission</td>
                            <td>
                                @if (permission.Namespace != null)
                                {
                                    <span><span class="text-muted">@Localizer["Namespace"]:</span> @(permission.ResourceName == "*" ? Localizer["ALL"] : permission.ResourceName)</span>
                                }
                                else if (permission.PageId != null)
                                {
                                    <span><span class="text-muted">@Localizer["Page"]:</span> @(permission.ResourceName == "*" ? Localizer["ALL"] : permission.ResourceName)</span>
                                }
                            </td>
                            <td><a class="btn btn-warning btn-thin" onclick="removePermission(this, '@permission.Id')">@Localizer["Remove"]</a></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="card shadow-lg mt-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center" id="toolbar">
                <div>
                    @*Left-aligned "toolbar" controls*@
                    <h4>@Localizer["Account Role Membership"]</h4>
                </div>

                <div>
                    @*Right-aligned "toolbar" controls*@
                    <button type="button" id="addAccountMembershipButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountMembershipModal">
                        @Localizer["Add Role to Account"]
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            @TightWiki.Library.PageSelectorGenerator.Generate(Context.Request.QueryString, Model.PaginationPageCount_Members, "Page_Memberships")

            <table id="membersTable" class="table fixedTable100 table-striped" border="0" cellspacing="0" cellpadding="0">
                <thead>
                    <tr>
                        <td><strong><a href="?@QueryStringConverter.OrderHelper(sessionState, "Role", "Memberships")">@Localizer["Name"]</a></strong></td>
                        <td><strong>@Localizer["Action"]</strong></td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var membership in Model.Memberships)
                    {
                        <tr>
                            <td><a href="@GlobalConfiguration.BasePath/AdminSecurity/Role/@membership.Name">@membership.Name</a></td>
                            <td><a class="btn btn-warning btn-thin" onclick="removeMembership(this, '@membership.Id')">@Localizer["Remove"]</a></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<script>
    async function removePermission(button, permissionId) {
        if (!confirm('@Localizer["Are you sure you want to remove the permission from this account?"]')) {
            return;
        }

        const response = await fetch(`@GlobalConfiguration.BasePath/AdminSecurity/RemoveAccountPermission/${permissionId}`, {
            method: 'POST',
        });

        if (!response.ok) {
            const txt = await response.text().catch(() => '');
            alert('Save failed: ' + (txt || `${response.status} ${response.statusText}`));
            return;
        }

        const result = await response.json();
            if (!result.success) {
            alert(result.message || '@Localizer["Removal failed"]');
            return;
        }

        button.closest("tr").remove();
    }

    async function removeMembership(button, userId) {
        if (!confirm('@Localizer["Are you sure you want to remove the role from this account?"]')) {
            return;
        }

        const response = await fetch(`@GlobalConfiguration.BasePath/AdminSecurity/RemoveAccountMembership/@Model.Id/${userId}`, {
            method: 'POST',
        });

        if (!response.ok) {
            const txt = await response.text().catch(() => '');
            alert('Save failed: ' + (txt || `${response.status} ${response.statusText}`));
            return;
        }

        const result = await response.json();
            if (!result.success) {
            alert(result.message || '@Localizer["Removal failed"]');
            return;
        }

        button.closest("tr").remove();
    }
</script>

<div class="modal" tabindex="-1" id="addPermissionToAccountModal" aria-labelledby="addPermissionToAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPermissionToAccountModalLabel">@Localizer["Add Permission to Account"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Localizer["Close"]"></button>
            </div>

            <div class="modal-body p-3">
                <div class="mb-3">
                    <label class="form-label fw-bold mt-2">@Localizer["Resource type"]</label><br />
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="addPermissionToAccountModalMode" id="addPermissionToAccountModalModePage" value="page" checked>
                        <label class="form-check-label" for="addPermissionToAccountModalModePage">@Localizer["Wiki Page"]</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="addPermissionToAccountModalMode" id="addPermissionToAccountModalModeNamespace" value="namespace">
                        <label class="form-check-label" for="addPermissionToAccountModalModeNamespace">@Localizer["Namespace"]</label>
                    </div>
                </div>

                <div>
                    <label for="addPermissionToAccountModalPageDisposition" class="form-label fw-bold mt-2">@Localizer["Disposition"]</label>
                    <select id="addPermissionToAccountModalPageDisposition" style="width: 100%"></select>
                </div>

                <div>
                    <label for="addPermissionToAccountModalPermission" class="form-label fw-bold mt-2">@Localizer["Permission"]</label>
                    <select id="addPermissionToAccountModalPermission" style="width: 100%"></select>
                </div>

                <div id="addPermissionToAccountModalPageDiv">
                    <label for="addPermissionToAccountModalPage" class="form-label fw-bold mt-2">@Localizer["Page"]</label>
                    <select id="addPermissionToAccountModalPage" style="width: 100%"></select>
                </div>

                <div id="addPermissionToAccountModalNamespaceDiv" style="display: none;">
                    <label for="addPermissionToAccountModalNamespace" class="form-label fw-bold mt-2">@Localizer["Namespace"]</label>
                    <select id="addPermissionToAccountModalNamespace" style="width: 100%"></select>
                </div>
            </div>

            <div class="modal-footer">
                <div class="container-fluid">
                    <em class="small"></em>
                    <button type="button" class="btn btn-success float-end" id="addPermissionToAccountModalInsertButton">@Localizer["Add"]</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    //addPermissionToAccountModal Modal

    const addPermissionToAccountModal = new bootstrap.Modal('#addPermissionToAccountModal');
    var addPermissionToAccountModalInitialized;

    //addPermissionToAccountModal modal is about to be shown.
    document.getElementById('addPermissionToAccountModal').addEventListener('shown.bs.modal', function() {
        if (addPermissionToAccountModalInitialized)
        {
            // Reset the defaults on the modal:
            document.getElementById('addPermissionToAccountModalModePage').checked = true;

            document.getElementById('addPermissionToAccountModalPageDiv').style.display = 'block';
            document.getElementById('addPermissionToAccountModalNamespaceDiv').style.display = 'none';

            $('#addPermissionToAccountModalPageDisposition').val(null).trigger('change');
            $('#addPermissionToAccountModalPermission').val(null).trigger('change');
            $('#addPermissionToAccountModalPage').val(null).trigger('change');
            $('#addPermissionToAccountModalNamespace').val(null).trigger('change');

            return;
        }

        $('#addPermissionToAccountModalPageDisposition').select2({
            placeholder: "@Localizer["Select a disposition"]",
            width: '100%',
            data: @Json.Serialize(Model.PermissionDispositions.Select(d => new { id = d.Id, text = d.Name })),
            allowClear: true,
            dropdownParent: $('#addPermissionToAccountModal'),
        }).on('change', function () {
            $(this).valid && $(this).valid();
        });

        $('#addPermissionToAccountModalPermission').select2({
            placeholder: "@Localizer["Select a permission"]",
            width: '100%',
            data: @Json.Serialize(Model.Permissions.Select(d => new { id = d.Id, text = d.Name })),
            allowClear: true,
            dropdownParent: $('#addPermissionToAccountModal'),
        }).on('change', function () {
            $(this).valid && $(this).valid();
        });

        $('#addPermissionToAccountModalPage').select2({
            dropdownParent: $('#addPermissionToAccountModal'),
            placeholder: "@Localizer["Select a page"]",
            minimumInputLength: 0,
            ajax: {
                url: '@GlobalConfiguration.BasePath/AdminSecurity/AutocompletePage',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                        showCatchAll: true
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(item => ({
                            id: item.id,
                            text: item.text
                        }))
                    };
                },
                cache: true
            }
        });

        $('#addPermissionToAccountModalNamespace').select2({
            dropdownParent: $('#addPermissionToAccountModal'),
            placeholder: "@Localizer["Select a namespace"]",
            minimumInputLength: 0,
            ajax: {
                url: '@GlobalConfiguration.BasePath/AdminSecurity/AutocompleteNamespace',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                        showCatchAll: true
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(item => ({
                            id: item.id,
                            text: item.text
                        }))
                    };
                },
                cache: true
            }
        });

        document.querySelectorAll('input[name="addPermissionToAccountModalMode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const mode = document.querySelector('input[name="addPermissionToAccountModalMode"]:checked').value;
                if (mode === 'page') {
                    document.getElementById('addPermissionToAccountModalPageDiv').style.display = 'block';
                    document.getElementById('addPermissionToAccountModalNamespaceDiv').style.display = 'none';
                } else {
                    document.getElementById('addPermissionToAccountModalPageDiv').style.display = 'none';
                    document.getElementById('addPermissionToAccountModalNamespaceDiv').style.display = 'block';
                }
            });
        });

        $('#addPermissionToAccountModalPageDisposition').val(null).trigger('change');
        $('#addPermissionToAccountModalPermission').val(null).trigger('change');
        $('#addPermissionToAccountModalPage').val(null).trigger('change');
        $('#addPermissionToAccountModalNamespace').val(null).trigger('change');

        addPermissionToAccountModalInitialized = true;
    });

    //User clicked the add button on the addPermissionToAccountModal
    document.getElementById('addPermissionToAccountModalInsertButton').addEventListener('click', async function () {

        let disposition = $('#addPermissionToAccountModalPageDisposition').select2('data');
        let permission = $('#addPermissionToAccountModalPermission').select2('data');
        let page = $('#addPermissionToAccountModalPage').select2('data');
        let namespace = $('#addPermissionToAccountModalNamespace').select2('data');

        let pageId;
        let namespaceId;

        if (!disposition) {
            alert("@Localizer["You must select a permission disposition."]");
            return;
        }
        if (!permission) {
            alert("@Localizer["You must select a permission."]");
            return;
        }

        if(document.getElementById('addPermissionToAccountModalModePage').checked == true)
        {
            if (!page) {
                alert("@Localizer["You must select a page."]");
                return;
            }
            pageId = page[0].id;
        }
        else if(document.getElementById('addPermissionToAccountModalModeNamespace').checked == true)
        {
            if (!namespace) {
                alert("@Localizer["You must select a namespace."]");
                return;
            }
            namespaceId = namespace[0].id;
        }
        else{
            alert("@Localizer["You must select either page or namespace."]");
        }

        const payload = {
            userId: '@Model.Id',
            permissionId: permission[0].id,
            permissionDispositionId: disposition[0].id,
            namespace: namespaceId,
            pageId: pageId
        };

        console.log(payload);

        const response = await fetch('@GlobalConfiguration.BasePath/AdminSecurity/AddAccountPermission', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const txt = await response.text().catch(() => '');
            alert('Save failed: ' + (txt || `${response.status} ${response.statusText}`));
            return;
        }

        const result = await response.json();
            if (!result.success) {
            alert(result.message || 'Save failed.');
            return;
        }

        if(result.alreadyExists)
        {
            alert('@Localizer["The role already has the specified permission."]')
            return;
        }
        const tableBody = document.querySelector("#permissionsTable tbody");

        const newRow = document.createElement("tr");

        newRow.innerHTML = `
            <td>
                ${
                    result.permission.permissionDisposition.toLowerCase() === "allow"
                        ? '<i class="bi bi-check2 text-success"></i>'
                        : '<i class="bi bi-ban text-danger"></i>'
                }
                ${result.permission.permissionDisposition}
            </td>
            <td>${result.permission.permission}</td>
            <td>
                ${
                    result.permission.namespace
                        ? `<span><span class="text-muted">Namespace:</span> ${result.permission.resourceName === "*" ? "ALL" : result.permission.resourceName}</span>`
                        : result.permission.pageId
                            ? `<span><span class="text-muted">Page:</span> ${result.permission.resourceName === "*" ? "ALL" : result.permission.resourceName}</span>`
                            : ""
                }
            </td>
            <td>
                <a class="btn btn-warning btn-thin" onclick="removePermission(this, '${result.permission.id}')">
                    @Localizer["Remove"]
                </a>
            </td>
        `;

        tableBody.appendChild(newRow);
        addPermissionToAccountModal.hide();
    });
</script>

<div class="modal" tabindex="-1" id="addAccountMembershipModal" aria-labelledby="addAccountMembershipModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAccountMembershipModalLabel">@Localizer["Add Member to Role"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Localizer["Close"]"></button>
            </div>

            <div class="modal-body p-3">
                <div>
                    <label for="addAccountMembershipModalAccount" class="form-label fw-bold">@Localizer["Account"]</label>
                    <select id="addAccountMembershipModalAccount" style="width: 100%"></select>
                </div>
            </div>

            <div class="modal-footer">
                <div class="container-fluid">
                    <em class="small"></em>
                    <button type="button" class="btn btn-success float-end" id="addAccountMembershipModalInsertButton">@Localizer["Add"]</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    //addAccountMembershipModal Modal

    const addAccountMembershipModal = new bootstrap.Modal('#addAccountMembershipModal');
    var addAccountMembershipModalInitialized;

    //addAccountMembershipModal modal is about to be shown.
    document.getElementById('addAccountMembershipModal').addEventListener('shown.bs.modal', function() {
        if (addAccountMembershipModalInitialized)
        {
            // Reset the defaults on the modal:
            $('#addAccountMembershipModalAccount').val(null).trigger('change');
            return;
        }
        $('#addAccountMembershipModalAccount').select2({
            dropdownParent: $('#addAccountMembershipModal'),
            placeholder: "@Localizer["Select an account"]",
            minimumInputLength: 0,
            ajax: {
                url: '@GlobalConfiguration.BasePath/AdminSecurity/AutoCompleteAccount',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.map(item => ({
                            id: item.id,
                            text: item.text
                        }))
                    };
                },
                cache: true
            }
        });

        $('#addAccountMembershipModalAccount').val(null).trigger('change');

        addAccountMembershipModalInitialized = true;
    });

    //User clicked the add button on the addAccountMembershipModal
    document.getElementById('addAccountMembershipModalInsertButton').addEventListener('click', async function () {

        let account = $('#addAccountMembershipModalAccount').select2('data');

        if (account.length <= 0) {
            alert("@Localizer["You must select an account."]");
            return;
        }

        const payload = {
            roleId: '@Model.Id', //These are backwards, right?
            userId: account[0].id, //These are backwards, right?
        };

        const response = await fetch('@GlobalConfiguration.BasePath/AdminSecurity/AddRoleMember', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const txt = await response.text().catch(() => '');
            alert('Save failed: ' + (txt || `${response.status} ${response.statusText}`));
            return;
        }

        const result = await response.json();
            if (!result.success) {
            alert(result.message || 'Save failed.');
            return;
        }

        if(result.alreadyExists)
        {
            alert('@Localizer["The account is already a member of the specified role."]')
            return;
        }

        const tableBody = document.querySelector("#membersTable tbody");
        const newRow = document.createElement("tr");

        newRow.innerHTML = `
            <td><a href="@GlobalConfiguration.BasePath/AdminSecurity/Account/${result.membership.navigation}">${result.membership.accountName}</a></td>
            <td>${result.membership.emailAddress}</td>
            <td>${result.membership.firstName}</td>
            <td>${result.membership.lastName}</td>
            <td><a class="btn btn-warning btn-thin" onclick="removeMembership(this, '${result.membership.is}')">@Localizer["Remove"]</a></td>
        `;

        tableBody.appendChild(newRow);

        addAccountMembershipModal.hide();
    });
</script>
